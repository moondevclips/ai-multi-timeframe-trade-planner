<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Challenge Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
        }
        .loader {
            border: 5px solid #374151;
            border-top: 5px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .upload-box {
            border: 2px dashed #4b5563;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .upload-box.uploaded {
            border-color: #10b981;
        }
        .upload-box.dragging-over {
            border-color: #2563eb;
            background-color: rgba(37, 99, 235, 0.1);
        }
        .result-card {
            background-color: #1f2937;
        }
        .progress-bar-bg { background-color: #374151; }
        .progress-bar { background-color: #ef4444; transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-400">AI Trading Challenge Simulator</h1>
            <p class="text-gray-400 mt-2">Analyze charts and track your performance against challenge rules.</p>
        </div>

        <!-- Challenge Dashboard -->
        <div id="challengeDashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 bg-gray-900/50 rounded-lg">
            <div>
                <p class="text-sm text-gray-400">Buying Power</p>
                <p id="buyingPower" class="text-2xl font-bold"></p>
            </div>
            <div>
                <p class="text-sm text-gray-400">Daily Drawdown (Max $60)</p>
                <div class="progress-bar-bg w-full rounded-full h-2.5 mt-2">
                    <div id="dailyDrawdownBar" class="progress-bar h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="dailyDrawdownValue" class="text-sm font-mono text-right"></p>
            </div>
            <div>
                <p class="text-sm text-gray-400">Total Drawdown (Max $140)</p>
                <div class="progress-bar-bg w-full rounded-full h-2.5 mt-2">
                    <div id="totalDrawdownBar" class="progress-bar h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                 <p id="totalDrawdownValue" class="text-sm font-mono text-right"></p>
            </div>
        </div>

        <!-- Main App Body -->
        <div id="mainAppBody">
            <div id="initialUploadSection">
                 <h2 class="text-xl font-semibold mb-4 text-center text-gray-300">Step 1: Generate Trade Plan</h2>
                <div class="grid md:grid-cols-3 gap-4 mb-6" id="initialUploadContainer"></div>
                <button id="analyzeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50" disabled>
                    Generate Trade Plan
                </button>
            </div>
            
            <div id="resultsContainer" class="hidden text-left p-6 bg-gray-900/50 rounded-lg mt-6">
                <div id="loader" class="loader mx-auto mb-4 hidden"></div>
                <div id="analysisResult" class="hidden">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4 text-center">AI Trade Plan</h2>
                    <div class="result-card p-4 rounded-lg mb-6"><canvas id="tradePlanChart"></canvas></div>
                    <div class="grid md:grid-cols-3 gap-4 mb-6 text-center">
                        <div class="result-card p-4 rounded-lg"><p class="text-sm">Entry Price</p><p id="entryPoint" class="text-2xl font-bold text-green-400"></p></div>
                        <div class="result-card p-4 rounded-lg"><p class="text-sm">Stop Loss</p><p id="stopLoss" class="text-2xl font-bold text-yellow-400"></p></div>
                        <div class="result-card p-4 rounded-lg"><p class="text-sm">Exit Target</p><p id="exitPoint" class="text-2xl font-bold text-red-400"></p></div>
                    </div>
                    
                    <!-- Log Trade Section -->
                    <div id="logTradeSection" class="mt-8 pt-6 border-t border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-center text-gray-300">Step 2: Log Simulated Trade</h2>
                        <div class="flex items-center gap-4 max-w-md mx-auto">
                            <div class="flex-1"><label for="tradeSymbol" class="block text-sm">Symbol</label><input type="text" id="tradeSymbol" class="bg-gray-700 border border-gray-600 w-full p-2.5 rounded-lg" placeholder="e.g., AAPL"></div>
                            <div class="flex-1"><label for="tradeQuantity" class="block text-sm">Quantity</label><input type="number" id="tradeQuantity" class="bg-gray-700 border border-gray-600 w-full p-2.5 rounded-lg" placeholder="e.g., 100" value="10"></div>
                        </div>
                        <div class="max-w-md mx-auto mt-4"><button id="logTradeBtn" class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-3 px-4 rounded-lg">Log Trade</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions & History -->
        <div id="positionsHistorySection" class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-center text-gray-300">Positions & History</h2>
            <div id="openPositions" class="space-y-2"></div>
            <div id="tradeHistory" class="mt-4 space-y-2"></div>
        </div>

    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let accountState = {
            buyingPower: 2000,
            dailyDrawdown: 0,
            totalDrawdown: 0,
            peakBalance: 2000,
            lastTradeDate: null,
            openPositions: [],
            tradeHistory: []
        };

        const CHALLENGE_RULES = {
            MAX_DAILY_DRAWDOWN: -60,
            MAX_TOTAL_DRAWDOWN: -140,
            STARTING_BALANCE: 2000
        };

        // --- DOM Elements ---
        const buyingPowerEl = document.getElementById('buyingPower');
        const dailyDrawdownBar = document.getElementById('dailyDrawdownBar');
        const dailyDrawdownValue = document.getElementById('dailyDrawdownValue');
        const totalDrawdownBar = document.getElementById('totalDrawdownBar');
        const totalDrawdownValue = document.getElementById('totalDrawdownValue');
        const initialUploadContainer = document.getElementById("initialUploadContainer");
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const analysisResult = document.getElementById('analysisResult');
        const entryPoint = document.getElementById('entryPoint');
        const stopLoss = document.getElementById('stopLoss');
        const exitPoint = document.getElementById('exitPoint');
        const tradePlanChartCanvas = document.getElementById('tradePlanChart');
        const logTradeBtn = document.getElementById('logTradeBtn');
        const tradeSymbolInput = document.getElementById('tradeSymbol');
        const tradeQuantityInput = document.getElementById('tradeQuantity');
        const openPositionsContainer = document.getElementById('openPositions');
        const tradeHistoryContainer = document.getElementById('tradeHistory');

        let chartSlots = [];
        let lastAnalysisResult = null;
        let nextSlotId = 1;
        let tradeChart = null;

        // --- INITIALIZATION ---
        function initializeApp() {
            loadState();
            updateDashboard();
            renderPositionsAndHistory();
            createUploadSlot(initialUploadContainer);
            createUploadSlot(initialUploadContainer);
            createUploadSlot(initialUploadContainer);
        }

        // --- STATE PERSISTENCE ---
        function saveState() {
            localStorage.setItem('tradingChallengeState', JSON.stringify(accountState));
        }

        function loadState() {
            const savedState = localStorage.getItem('tradingChallengeState');
            if (savedState) {
                accountState = JSON.parse(savedState);
            }
        }

        // --- UI UPDATES ---
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            if (accountState.lastTradeDate !== today) {
                accountState.dailyDrawdown = 0;
            }

            buyingPowerEl.textContent = `$${accountState.buyingPower.toFixed(2)}`;
            
            const dailyDDPercent = Math.min(100, (accountState.dailyDrawdown / CHALLENGE_RULES.MAX_DAILY_DRAWDOWN) * 100);
            dailyDrawdownBar.style.width = `${dailyDDPercent}%`;
            dailyDrawdownValue.textContent = `$${accountState.dailyDrawdown.toFixed(2)}`;
            
            const totalDDPercent = Math.min(100, (accountState.totalDrawdown / CHALLENGE_RULES.MAX_TOTAL_DRAWDOWN) * 100);
            totalDrawdownBar.style.width = `${totalDDPercent}%`;
            totalDrawdownValue.textContent = `$${accountState.totalDrawdown.toFixed(2)}`;
        }

        // --- TRADE LOGIC ---
        logTradeBtn.addEventListener('click', () => {
            const symbol = tradeSymbolInput.value.trim().toUpperCase();
            const quantity = parseInt(tradeQuantityInput.value, 10);

            if (!symbol || !quantity || !lastAnalysisResult) {
                alert("Please provide a symbol, quantity, and generate a trade plan first.");
                return;
            }

            const tradeCost = parseFloat(lastAnalysisResult.tradePlan.entry) * quantity;
            if (tradeCost > accountState.buyingPower) {
                alert("Not enough buying power for this trade.");
                return;
            }

            const newPosition = {
                id: Date.now(),
                symbol,
                quantity,
                entry: parseFloat(lastAnalysisResult.tradePlan.entry),
                stop: parseFloat(lastAnalysisResult.tradePlan.stopLoss),
                target: parseFloat(lastAnalysisResult.tradePlan.exit),
            };

            accountState.openPositions.push(newPosition);
            accountState.buyingPower -= tradeCost;
            
            saveState();
            updateDashboard();
            renderPositionsAndHistory();
            alert(`Trade for ${quantity} of ${symbol} logged successfully!`);
        });

        function closePosition(positionId, outcome) {
            const positionIndex = accountState.openPositions.findIndex(p => p.id === positionId);
            if (positionIndex === -1) return;

            const position = accountState.openPositions[positionIndex];
            const entryValue = position.entry * position.quantity;
            let pnl;

            if (outcome === 'win') {
                pnl = (position.target - position.entry) * position.quantity;
                accountState.buyingPower += position.target * position.quantity;
            } else { // loss
                pnl = (position.stop - position.entry) * position.quantity;
                accountState.buyingPower += position.stop * position.quantity;
            }

            const today = new Date().toISOString().split('T')[0];
            if (accountState.lastTradeDate !== today) {
                accountState.dailyDrawdown = 0;
            }
            accountState.lastTradeDate = today;
            
            if (pnl < 0) {
                accountState.dailyDrawdown += pnl;
            }

            const currentBalance = accountState.buyingPower + accountState.openPositions.reduce((acc, pos) => acc + (pos.entry * pos.quantity), 0);
            accountState.peakBalance = Math.max(accountState.peakBalance, currentBalance);
            accountState.totalDrawdown = Math.min(0, currentBalance - accountState.peakBalance);

            accountState.openPositions.splice(positionIndex, 1);
            accountState.tradeHistory.push({ ...position, pnl, outcome });
            
            saveState();
            updateDashboard();
            renderPositionsAndHistory();
        }

        function renderPositionsAndHistory() {
            openPositionsContainer.innerHTML = '<h4>Open Positions</h4>';
            if(accountState.openPositions.length === 0) {
                openPositionsContainer.innerHTML += '<p class="text-sm text-gray-500">No open positions.</p>';
            }
            accountState.openPositions.forEach(pos => {
                const posEl = document.createElement('div');
                posEl.className = 'result-card p-3 rounded-lg flex justify-between items-center';
                posEl.innerHTML = `
                    <div>
                        <p class="font-bold">${pos.quantity} ${pos.symbol} @ $${pos.entry.toFixed(2)}</p>
                        <p class="text-xs text-gray-400">Target: $${pos.target.toFixed(2)} | Stop: $${pos.stop.toFixed(2)}</p>
                    </div>
                    <div class="space-x-2">
                        <button onclick="closePosition(${pos.id}, 'win')" class="bg-green-600 text-xs px-2 py-1 rounded">Close Win</button>
                        <button onclick="closePosition(${pos.id}, 'loss')" class="bg-red-600 text-xs px-2 py-1 rounded">Close Loss</button>
                    </div>
                `;
                openPositionsContainer.appendChild(posEl);
            });

            tradeHistoryContainer.innerHTML = '<h4>Trade History</h4>';
             if(accountState.tradeHistory.length === 0) {
                tradeHistoryContainer.innerHTML += '<p class="text-sm text-gray-500">No trades yet.</p>';
            }
            [...accountState.tradeHistory].reverse().forEach(trade => {
                const tradeEl = document.createElement('div');
                const pnlClass = trade.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                tradeEl.className = 'result-card p-3 rounded-lg flex justify-between items-center';
                tradeEl.innerHTML = `
                    <p>${trade.quantity} ${trade.symbol}</p>
                    <p class="font-mono ${pnlClass}">P/L: $${trade.pnl.toFixed(2)}</p>
                `;
                tradeHistoryContainer.appendChild(tradeEl);
            });
        }
        
        // --- ANALYSIS & UPLOAD LOGIC (Mostly Unchanged) ---
        function createUploadSlot(container) {
            const slotId = nextSlotId++;
            const defaultTimeframes = { 1: 'Daily', 2: '4-Hour', 3: '1-Hour' };
            const defaultTimeframe = defaultTimeframes[slotId] || '15-Minute';

            const slot = { id: slotId, timeframe: defaultTimeframe, base64: null, fileName: null };
            chartSlots.push(slot);

            const slotEl = document.createElement('div');
            slotEl.id = `uploadSlot${slotId}`;
            slotEl.className = 'upload-box p-4 rounded-lg text-center';
            slotEl.innerHTML = `<select data-slot-id="${slotId}" class="timeframe-select bg-gray-700 w-full p-2 mb-2 rounded-lg"><option>Daily</option><option>Weekly</option><option>4-Hour</option><option>1-Hour</option><option>15-Minute</option></select><label for="uploader${slotId}" class="cursor-pointer"><img id="preview${slotId}" src="" class="hidden mx-auto h-24 mb-2 rounded"><svg id="icon${slotId}" class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg><p class="text-sm text-blue-400">Click or drag file</p><p id="fileName${slotId}" class="text-xs text-gray-500 truncate"></p></label><input id="uploader${slotId}" type="file" class="sr-only" accept="image/*">`;
            container.appendChild(slotEl);
            slotEl.querySelector('.timeframe-select').value = defaultTimeframe;
            setupUploaderLogic(slotId);
        }

        function setupUploaderLogic(slotId) {
            const uploader = document.getElementById(`uploader${slotId}`);
            const uploadBox = document.getElementById(`uploadSlot${slotId}`);
            const slotData = chartSlots.find(s => s.id === slotId);

            const handleFile = (file) => {
                if (!file) return;
                slotData.fileName = file.name;
                document.getElementById(`fileName${slotId}`).textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(`preview${slotId}`).src = e.target.result;
                    document.getElementById(`preview${slotId}`).classList.remove('hidden');
                    document.getElementById(`icon${slotId}`).classList.add('hidden');
                    uploadBox.classList.add('uploaded');
                    slotData.base64 = e.target.result.split(',')[1];
                    analyzeBtn.disabled = chartSlots.slice(0, 3).some(s => !s.base64);
                };
                reader.readAsDataURL(file);
            };
            uploader.addEventListener('change', (e) => handleFile(e.target.files[0]));
            uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.classList.add('dragging-over'); });
            uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragging-over'));
            uploadBox.addEventListener('drop', (e) => { e.preventDefault(); uploadBox.classList.remove('dragging-over'); handleFile(e.dataTransfer.files[0]); });
        }
        
        analyzeBtn.addEventListener('click', async () => {
             const apiKey = "PASTE_YOUR_API_KEY_HERE";
             if (apiKey === "PASTE_YOUR_API_KEY_HERE" || apiKey === "") {
                alert("API Key is missing.");
                return;
            }
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            analysisResult.classList.add('hidden');
            try {
                const activeSlots = chartSlots.filter(s => s.base64);
                const timeframes = activeSlots.map(s => s.timeframe).join(', ');
                const analysisJsonStructure = activeSlots.map(s => `"${s.timeframe}": { "summary": "...", "patterns": [], "indicators": "..." }`).join(',');
                const prompt = `You are an expert institutional-level technical analyst... [rest of prompt] ... Return the result as a single, minified JSON object: { "tradePlan": { "entry": "...", "exit": "...", "stopLoss": "..." }, "confidence": { "probability": "...", "assessment": "..." }, "analysis": { ${analysisJsonStructure} }, "executionStrategy": "..." }`;
                const parts = [{ text: prompt }];
                activeSlots.forEach(slot => {
                    parts.push({ text: `\n${slot.timeframe} Chart:` });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: slot.base64 } });
                });
                const payload = { contents: [{ parts: parts }], generationConfig: { responseMimeType: "application/json" } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                lastAnalysisResult = JSON.parse(text);
                displayResults(lastAnalysisResult);
            } catch (error) {
                console.error("Error:", error);
            } finally {
                loader.classList.add('hidden');
                analysisResult.classList.remove('hidden');
            }
        });

        function displayResults(data) {
            entryPoint.textContent = `$${data.tradePlan.entry}`;
            stopLoss.textContent = `$${data.tradePlan.stopLoss}`;
            exitPoint.textContent = `$${data.tradePlan.exit}`;
            // probability.textContent = data.confidence.probability;
            // assessment.textContent = data.confidence.assessment;
            // executionStrategy.textContent = data.executionStrategy;
            drawVisualPlan(data.tradePlan);
        }

        function drawVisualPlan(tradePlan) {
            if (tradeChart) tradeChart.destroy();
            const entry = parseFloat(tradePlan.entry);
            const exit = parseFloat(tradePlan.exit);
            const stop = parseFloat(tradePlan.stopLoss);
            const range = Math.abs(exit - stop) * 1.5;
            let priceData = [entry - (Math.random() - 0.5) * range * 0.2];
            for (let i = 1; i < 20; i++) priceData.push(priceData[i - 1] + (Math.random() - 0.45) * range * 0.15);
            tradeChart = new Chart(tradePlanChartCanvas, {
                type: 'line',
                data: { labels: Array.from({length: 20}, (_, i) => i + 1), datasets: [{ data: priceData, borderColor: '#9CA3AF' }] },
                options: { scales: { y: { ticks: { color: '#9CA3AF' } }, x: { display: false } }, plugins: { legend: { display: false }, annotation: { annotations: { entryLine: { type: 'line', yMin: entry, yMax: entry, borderColor: 'rgb(34, 197, 94)', borderWidth: 2, label: { content: `Entry: ${entry}`, enabled: true, position: 'start' } }, exitLine: { type: 'line', yMin: exit, yMax: exit, borderColor: 'rgb(59, 130, 246)', borderWidth: 2, label: { content: `Target: ${exit}`, enabled: true, position: 'start' } }, stopLossLine: { type: 'line', yMin: stop, yMax: stop, borderColor: 'rgb(239, 68, 68)', borderWidth: 2, label: { content: `Stop: ${stop}`, enabled: true, position: 'start' } } } } } }
            });
        }
        
        initializeApp();
    </script>
</body>
</html>
